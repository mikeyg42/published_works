<!DOCTYPE html>
<html>
<head>
    <title>Direct WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #log { 
            background-color: #f4f4f4; 
            padding: 10px; 
            height: 300px; 
            overflow-y: auto;
            font-family: monospace;
        }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Direct WebSocket Test</h1>
    
    <div>
        <p>Test URL: <input type="text" id="ws-url" style="width: 500px;" value="wss://maze-solver-backend-acn3zn6u4a-uc.a.run.app/maze-solver"></p>
        <button onclick="connect()">Connect</button>
        <button onclick="sendTest()">Send Test Message</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <h2>Log:</h2>
    <div id="log"></div>
    
    <script>
        let socket = null;
        const log = document.getElementById('log');
        
        function addLogEntry(message, isError = false) {
            const entry = document.createElement('div');
            entry.className = isError ? 'error' : 'success';
            const time = new Date().toISOString();
            entry.textContent = `${time}: ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            console.log(isError ? `ERROR: ${message}` : message);
        }
        
        function clearLog() {
            log.innerHTML = '';
        }
        
        function connect() {
            try {
                const url = document.getElementById('ws-url').value;
                addLogEntry(`Attempting to connect to ${url}...`);
                
                socket = new WebSocket(url);
                
                socket.onopen = (event) => {
                    addLogEntry(`Connection OPEN - WebSocket connected successfully!`);
                };
                
                socket.onmessage = (event) => {
                    addLogEntry(`RECEIVED: ${event.data}`);
                };
                
                socket.onerror = (event) => {
                    addLogEntry(`ERROR: WebSocket error occurred`, true);
                    console.error('WebSocket error:', event);
                };
                
                socket.onclose = (event) => {
                    let reason = '';
                    // See https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent/code for codes
                    switch (event.code) {
                        case 1000: reason = "Normal closure"; break;
                        case 1001: reason = "Going away"; break;
                        case 1002: reason = "Protocol error"; break;
                        case 1003: reason = "Unsupported data"; break;
                        case 1004: reason = "Reserved"; break;
                        case 1005: reason = "No status received"; break;
                        case 1006: reason = "Abnormal closure"; break;
                        case 1007: reason = "Invalid frame payload data"; break;
                        case 1008: reason = "Policy violation"; break;
                        case 1009: reason = "Message too big"; break;
                        case 1010: reason = "Mandatory extension"; break;
                        case 1011: reason = "Internal server error"; break;
                        case 1012: reason = "Service restart"; break;
                        case 1013: reason = "Try again later"; break;
                        case 1014: reason = "Bad gateway"; break;
                        case 1015: reason = "TLS handshake"; break;
                        default: reason = "Unknown";
                    }
                    
                    addLogEntry(`Connection CLOSED: Code=${event.code} (${reason}), Clean=${event.wasClean}`, event.code !== 1000);
                    socket = null;
                };
            } catch (error) {
                addLogEntry(`ERROR: ${error.message}`, true);
            }
        }
        
        function sendTest() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addLogEntry("ERROR: Socket not connected or not open", true);
                return;
            }
            
            try {
                const testMsg = {
                    type: "test",
                    message: "Hello from direct test page",
                    timestamp: new Date().toISOString()
                };
                
                const msgString = JSON.stringify(testMsg);
                socket.send(msgString);
                addLogEntry(`SENT: ${msgString}`);
            } catch (error) {
                addLogEntry(`ERROR SENDING: ${error.message}`, true);
            }
        }
        
        function disconnect() {
            if (!socket) {
                addLogEntry("ERROR: No active connection", true);
                return;
            }
            
            try {
                socket.close(1000, "User requested disconnect");
                addLogEntry("Disconnecting...");
            } catch (error) {
                addLogEntry(`ERROR DISCONNECTING: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>